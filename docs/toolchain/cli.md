# Locus CLI Reference

The `locus` command-line interface is your main tool for managing Locus projects. It provides commands for project creation, development, building, testing, database management, deployment, and extensibility.

## Core Commands

### `locus new <project_name>`
Scaffold a new project with boilerplate files and configuration.

### `locus dev`
Start the development server with hot-reloading for frontend and backend.

#### Error Output Format

Both `locus build` and `locus dev` support structured error output for editor/tool integrations:

- `--errors pretty` (default): Human-friendly boxed messages with codeframes.
- `--errors json`: One JSON object per error written to stderr.

JSON schema (stable fields):

```
{
	"code": "parse_error" | "lex_error" | "validation_error" | "merge_error",
	"message": string,        // Friendly message, e.g., "Expected ':' but found 'String'"
	"rawMessage": string,     // Underlying message from the parser/lexer/throw site
	"filePath": string | null,
	"line": number | null,
	"column": number | null,
	"length": number | null,  // Length of the highlighted span
	"heading": string         // e.g., "Parse Error", "Validation Error"
}
```

Example:

```
$ locus build --errors json
{"code":"parse_error","message":"Expected ':' but found 'String'","rawMessage":"Expecting token of type --> Colon <-- but found --> 'String' <--","filePath":"src/db.locus","line":4,"column":12,"length":6,"heading":"Parse Error"}
```

### `locus build`
Compile and optimize your project for production.

#### Generated Outputs
Deterministic artifacts (relative to `--out`, default `generated/`):

- `prisma/schema.prisma` – Prisma data model
- `routes/**/*.ts` & `server.ts` – Express API scaffolding
- `react/pages/*.tsx` – Generated React pages
- `react/components/*.tsx` – Generated React components
- `theme.css` – Design tokens as CSS custom properties
- `next-app/app/**/*` – Minimal Next.js App Router shell
- `next-app/public/theme.css` – Theme duplication for static serving
- `package.json` – Created only if absent (app name from `Locus.toml` `[app].name`)
- `README.md` – Quickstart (only if absent)

All files begin with:
```ts
// AUTO-GENERATED by Locus. DO NOT EDIT.
```

#### Flags
- `--out <dir>`: Output directory (default `generated`)
- `--errors <pretty|json>`: Error rendering style
- `--prisma-generate`: Run `npx prisma generate` after writing outputs
- `--dry-run`: Print planned files; perform no writes or side effects

Example dry run:
```bash
locus build --dry-run
[locus][build][dry-run] files that would be written:
 - prisma/schema.prisma
 - routes/user.ts
 - react/pages/Home.tsx
 ...
```

#### Determinism & Ordering
Artifacts are sorted (alphabetically or by entity/page name) to ensure stable diffs and snapshot-friendly output.

#### Side Effects
No dependency install, server start, or Prisma client generation unless explicitly requested with `--prisma-generate`.

#### Package Name Resolution
If `Locus.toml` contains:
```toml
[app]
name = "my-app"
```
the generated `package.json` uses `my-app`; otherwise falls back to `locus-generated-app`.

### `locus dev`
Start the development server with hot-reloading for frontend and backend.

#### Incremental Generation
Performs an initial full build (same artifacts as `locus build`), then regenerates only the files whose content changes. A content cache avoids redundant disk writes.

Change feedback:
- Summary: `[locus][dev] regenerated N files`
- Verbose list (when `LOCUS_DEBUG=1`): `[locus][dev][changed] react/pages/Home.tsx, prisma/schema.prisma, theme.css`

`package.json` & `README.md` are generated once if absent; never overwritten.

#### Shared Artifact Module
Both build and dev use a shared internal artifact assembler ensuring feature parity and single-point evolution (e.g., adding an OpenAPI generator in the future).

### `locus db migrate '<name>'`
Generate and apply database migrations based on your data model.

### `locus db studio`
Launch Prisma Studio to view and edit your database.

### `locus test`
Run all tests defined in your `.locus` files.

### `locus deploy`
Build and deploy your app to modern hosting platforms (Vercel, Railway, Supabase, etc.).

### `locus add <package>`
Install npm packages into the generated frontend or backend.

## Advanced Usage

- All commands work with zero configuration, but can be customized via `Locus.toml`.
- The CLI supports plugins for new commands and integrations.

See [Development Workflow](./development-workflow.md) and [Deployment](./deployment.md) for more details.

## Generated Package Manifest (Example)
```json
{
	"name": "my-app",
	"private": true,
	"scripts": {
		"dev:api": "node server.ts",
		"dev:next": "next dev next-app",
		"dev": "npm run dev:api & npm run dev:next",
		"prisma:generate": "prisma generate",
		"build": "next build next-app",
		"start": "next start next-app"
	},
	"dependencies": {
		"express": "^4.19.2",
		"@prisma/client": "^5.15.0",
		"cors": "^2.8.5",
		"react": "^18.3.1",
		"react-dom": "^18.3.1",
		"next": "^14.2.0"
	},
	"devDependencies": { "prisma": "^5.15.0" }
}
```
React / Next dependencies are only added if pages exist.

## Theming
`theme.css` (design tokens) is also copied to `next-app/public/theme.css` so it is served at `/theme.css` for the Next shell.

## Prisma Client Options
Generate the Prisma client via either:
1. `locus build --prisma-generate`
2. `npm run prisma:generate` inside the generated directory

Opt-in keeps builds fast and deterministic for CI and dry runs.

## Dry Run Scenarios
Use `--dry-run` for CI planning, editor previews, plugin development, or diff inspection without touching the filesystem.

## Incremental Strategy Details
Dev mode stores last written contents and rewrites only when changed, minimizing I/O churn and reducing risk of watcher loops.

## Roadmap (Planned Hooks)
- `--openapi` to emit OpenAPI specs
- `--emit-client-only` to skip server/UI emission
- Plugin API to register custom artifact contributors

Feedback or proposals welcome—open an issue or submit a design doc PR.

## Troubleshooting

Prisma client not found:
- Run `locus build --prisma-generate` or inside generated dir run `npm run prisma:generate`.
- Ensure `.env` has a valid `DATABASE_URL`.
## Dev Mode

### Startup Banner

Running `locus dev` now prints a concise banner summarizing the running environment:

```
┌────────────────────────────────────────────┐
│ App: my-app                                │
│ API:  http://localhost:3001  (routes: 3)   │
│ Web:  http://localhost:3000                │
│ Theme: ✓   Prisma: ✗ (run prisma generate) │
│ Watching: **/*.locus                       │
│ CORS: off  NODE_ENV: development           │
│ Ctrl+C to stop                             │
└────────────────────────────────────────────┘
```

Legend:
- API/Web: Base URLs. API port precedence: `API_PORT` > `PORT` > 3001.
- routes: Count of generated Express route files.
- Theme: Whether `theme.css` was generated.
- Prisma: Whether `@prisma/client` is resolvable (hint shown if missing).
- Watching: Glob pattern for incremental rebuild.
- CORS: Enabled when `ENABLE_CORS=1`.

The banner appears once after the initial build. Subsequent rebuilds log concise `[locus][dev] regenerated N files` messages. Use `LOCUS_DEBUG=1` for extra timing details (future enhancement).
`--quiet` suppresses the banner and startup lines (only regeneration or error lines remain).

With `LOCUS_DEBUG=1` each change batch prints an additional line:
```
[locus][dev][timing] batch=2 total=15 dt=42ms
```
Meaning: last batch rewrote 2 files, cumulative rewrites 15, 42ms since previous batch.

Port conflicts:
- API defaults to `PORT` env var or 3001. Set a free port: `PORT=4001 locus dev`.
- Next.js dev server (if present) uses 3000; set `PORT=4002` if you have another service at 3001.

Missing theme.css in browser:
- Confirm `theme.css` exists in output root and `next-app/public/theme.css`.
- Ensure landing page `<head>` loads `globals.css` which imports `/theme.css`.

CORS blocked requests:
- Set `ENABLE_CORS=1` when running dev/build server to enable basic CORS middleware.

Regeneration not triggering:
- Check that file is within watched src directory passed to `--src`.
- Use `LOCUS_DEBUG=1 locus dev` to print changed file list.

## Route Naming Policy

Generated Next routes use kebab-case derived from Locus page names (e.g., `UserProfile` -> `/user-profile`).

API entity routes default to the lowerCamel entity name (e.g., `User` -> `/user`). An experimental pluralization option (internal flag) transforms route mounts to plural forms (`/users`, `Category` -> `/categories`). This will surface as a formal CLI/config option in a future release.

Port selection precedence for the API server: `API_PORT` > `PORT` > 3001.

See also: [Common Errors & Fixes](../guides/common-errors.md).
